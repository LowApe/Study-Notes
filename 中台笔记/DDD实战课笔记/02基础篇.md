# 基础篇

# 领域驱动设计

## 软件架构模式的演进图：

![image.png](http://ww1.sinaimg.cn/large/006rAlqhgy1go7nc753nkj312q0k8k0k.jpg)

> 单机和集中式框架，系统分析、设计和开发往往是独立、分阶段割裂进行的。这样的流程周期长，经手的人多，**很容易导致信息丢失**

## 微服务设计和拆分的困境

> 微服务解决了原来采用集中式架构的单体应用的很多问题，**比如扩展性、弹性伸缩能力、小规模团队的敏捷开发等等**。但也带来了一些问题：
>
> - 微服务的粒度应该多大？
> - 微服务到底如何拆分和设计？
> - 微服务的边界在哪里？

微服务拆分困境的产生的根本原因就是**不知道业务或者微服务的边界**到底在什么地方。换句话说，**确定了业务边界和应用边界**，这个困境就可以解决🤔

- **DDD核心思想是通过领域驱动设计方法定义领域模型，从而确定业务和应用边界，保证业务模型与代码模型的一致性**

## 为什么DDD适合微服务？

> DDD是一种处理高度复杂领域的设计思想，它试图分离技术实现的复杂性，并围绕业务概念构建领域模型来控制业务的复杂性，以解决软件难以理解，难以演进的问题。**DDD不是框架，而是一种架构设计方法论，通过边界划分将复杂业务领域简单化，帮我们设计出清晰的领域和应用边界，可以很容易地实现架构演进**

**DDD包括战略设计和战术设计两部分**

- 战略设计主要从 **业务视角出发，建立业务领域模型，划分领域边界，建立通用语言的限界上下文，限界上下文可以作为领域设计的参考边界**
- 战术设计则从 **技术视角出发，侧重领域模型的实现，完成软件开发和落地**，包括：聚合根、实体、值对象、领域服务、应用服务和资源库等代码逻辑的设计和实现



> 事件风暴是创建领域模型的主要方法，它是一个从发散到收敛的过程。它通常采用 **用例分析、场景分析、用户旅程分析**，尽可能全面不遗漏地分散业务领域，并梳理领域对象之间的关系，这是一个发散的过程。

事件风暴过程会产生很多的实体、命令、事件等领域对象，我们将这些领域对象从不同的维度进行聚类，形成 **聚合、界限上下文等边界，建立领域模型**这就是一个收敛的过程。

## 划分领域模型和微服务的边界



![image.png](http://ww1.sinaimg.cn/large/006rAlqhgy1go7opwt152j312c0pwk6w.jpg)



1. 在事件风暴中梳理业务过程中的**用户操作、事件以及外部依赖关系**等，根据这些要素梳理出**领域实体等领域对象**
2. 根据领域实体之间的业务关联性，将业务紧密相关的实体进行组合形成聚合，同时确定聚合中的聚合根、值对象和实体。聚合之间的边界是第一层边界，它们在同一个微服务实例中运行。如图虚线
3. 根据业务及语义边界等因素，将一个或者多个聚合划定在一个限界上下文内，形成领域模型。限界上下文之间的边界是第二层边界，这一层边界可能就是未来微服务的边界。**不同限界上下文内的领域逻辑被隔离在不同的微服务实例中运行，物理上相互隔离，所以是物理边界，边界之间用实线来表示**

> 从业务模型向微服务落地的过程中，也就是从战略设计向战术设计的实施过程，我们会将领域模型中领域对象与代码模型中的代码对象建立映射关系，将业务架构和系统架构进行绑定。**当我们响应业务变化调整业务架构和领域模型时，系统架构也会同时发生调整，并同步建立新的映射关系**

## DDD 与微服务的关系

总结一下 DDD 与微服务的关系

DDD 是一种架构设计方法，微服务是一种架构风格，两者从本质上都是为了追求高响应力，而从业务视角去分离应用系统建设复杂度的手段。两者都根据业务发展，**合理划分领域边界，持续调整现有框架，优化现有代码，以保持架构和代码的生命力**，也就是我们常说的演进式框架



> DDD主要关注：从业务领域视角划分领域边界，构建通用语言进行高效沟通，通过业务抽象，建立领域模型，维持业务和代码的逻辑一致性
>
> 微服务主要关注：运行时的进程间通信、容错和故障隔离，实现去中心化数据管理和去中心化服务治理，关注微服务的独立开发、测试、构建和部署



# DDD术语概念

> 在研究和解决业务问题时，DDD 会按照一定的**规则**将业务领域进行细分，当领域细分到一定的程度后，DDD会将问题范围限定在特定的边界内，在这个边界内建立领域模型，进而代码实现该领域模型，解决响应的业务问题



## 如何理解领域和子域？

- 两个解释有一个共同点——范围
- DDD 的领域就是这个边界内要解决的业务问题域

- 领域可以进行一步划分为子领域，我们把划分出来的多个子领域称为子域，每个子域对应一个更小的问题或更小的业务范围
- 分布式微服务架构就需要划分业务领域边界，建立领域模型，并实现微服务落地

> 实例：保险系统，为了实现保险领域建模和微服务建设，我们可以根据业务关联度以及流程边界将保险**领域**细分为：承保、收付、再保以及理赔等**子域**，
>
> 而承保子域可以继续细分为投保、保全、批改等子子域。在投保这个**限界上下文**内可以建立投保的**领域模型**，投保的领域模型最后映射到系统就是投保微服务。这就是一个保险领域的细分和微服务的建设过程。

## 如何理解核心域、通用域和支撑域？

- 子域可以根据滋生重要性和功能属性划分为三类子域，它们分别是：核心域、通用域和支撑域
- 决定产品和公司核心竞争力的子域是**核心域**，它是业务成功的主要因素和核心竞争力。
- 同时被多个子域使用的通用功能子域是**通用域**
- 还有一种功能**子域是必需的**，但既不包括决定产品和公司核心竞争力的功能，也不包括通用功能子域，它就是**支持域**

## 那为什么要划分核心域、通用域和支持域，主要目的是什么呢？

在公司在 IT 系统建设中，由于预算和资源有限，对不同类型的子域应有不同的关注度和资源投入策略，好钢要用在刀刃上

商业模式的不同会导致核心域划分结果的不同。有的公司核心域可能在客户服务，有的可能在产品质量，有的可能在物流。**在公司领域细分、建立领域模型和系统建设时，我们就要结合公司战略重点和商业模式，找到核心域了，且重点关注核心域**



## 总结

- 领域的核心思想就是将问题域逐级细分，来降低业务理解和系统实现的复杂度。通过领域细分，逐步缩小微服务需要解决的问题域，构建合适的领域模型，而领域模型映射成系统就是微服务

# 限界上下文



## 什么是通用语言？

> 在事件风暴过程中，通过团队交流达到共识的，能够简单、清晰、准确描述业务涵义和规则的语言就是同于语言。
>
> 通用语言包含**术语**和**用例场景**，并且能够直接反映在代码中。
>
> - 通用语言中的**名词**可以给领域对象命名，如商品、订单等
> - 而**动词**则表示一个动作或事件，如商品已下单、订单已付款等，对应领域事件或者命令
>
> 通用语言贯穿 DDD 的整个设计过程。作为项目团队沟通和协商形成的统一语言，基于它，你就能够开发出可读性更好的代码，**将业务需求准确转化为代码设计**

从事件风暴建立通用语言到领域对象设计和代码落地的完整过程：

![image.png](http://ww1.sinaimg.cn/large/006rAlqhgy1go920n2168j31120qg77t.jpg)

1. 在事件风暴的过程中，领域专家会和设计、开发人员一起建立领域模型，在领域建模的过程中会形成通用的业务术语和用户故事。**事件风暴也是一个项目团队统一语言的过程**
2. 通过用户故事分析会形成一个个的领域对象，这些领域对象对应领域模型的业务对象，每一个业务对象和领域对象都有通用的名称术语，并且一一映射
3. 微服务代码模型来源于 **领域模型**，每个代码模型的代码对象根领域对象一一对应

> 设计过程中我们可以用一些表格，来记录事件风暴和微服务设计过程中产生的领域对象及其属性。

![image.png](http://ww1.sinaimg.cn/large/006rAlqhgy1go92pn4ytlj31380iek79.jpg)

DDD 分析和设计过程中的每一个环节都需要保证限界上下文内术语的统一，在代码模型设计的时候就要建立领域对象和代码对象的一一映射，从而保证**业务模型和代码模型**的一致，实现业务语言与代码语言的统一

**什么是限界上下文？**

我们可以将限界上下文拆解为两个词：限界和上下文。限界就是领域的边界，而上下文则是语义环境。通过领域的限界上下文，我们就可以在统一的领域边界内用统一的语言进行交流。

> 限界上下文的定义就是：用来封装通用语言和领域对象，提供上下文环境，保证在领域之内的一些术语、业务相关对象等(通用语言)有一个确切的含义，没有二义性。这个边界定义了模型的使用范围，使团队所有成员能够明确地知道什么应该在模型中实现，什么不应该在模型中实现

## 进一步理解限界上下文

所以语言离不开它的语义环境，就像中文同一个句子，在不同的环境下意思不同。

> 保险业务领域有投保单、保单、批单、赔案等保险术语,它们分别应用于保险的不同业务流程。它们分别应用于保险的不同业务流程
>
> 1. 客户投保时，业务人员记录投保信息，系统对应有投保单实体对象
> 2. 缴费完成后，业务员人员投保单转为保单，系统对应有保单实体对象，保单实体与投保但实体关联
> 3. 如客户需要修改保单信息，保单变为批单，系统对应有批单实体对象，批单实体与保单实体关联
> 4. 如果客户发生理赔，生成赔
> 5. ...

投保单、保单、批单、赔案等，这些术语虽然都跟保单有关，但不能将保单这个术语作用在保险全业务领域。因为术语有它的边界，超过了边界理解上就会出现问题.正如 **电商领域的商品一样，商品在不同的阶段有不同的术语，在销售阶段是商品，而在运输阶段则变成了货物。**同样的一个东西，由于业务领域的不同，赋予了这些术语不同的涵义和职责边界，**这个边界就可能会成为未来微服务设计的边界。**

## 限界上下文和微服务的关系

> 案例：车险承保的流程包含了投保、缴费、出单等几个主要流程。如果出险了还会有报案、查勘、定损、理算等赔偿流程

![image.png](http://ww1.sinaimg.cn/large/006rAlqhgy1go94tsw8kpj312q0rktgp.jpg)

首先，领域可以拆分为多个子领域。一个领域相当于一个问题域，领域拆分为子域的过程就是大问题拆分为小问题的过程。在这个图里面保险领域被拆分为：投保、支付、保单管理和理赔四个子域。

子域还可根据需要进一步划分为子子域，比如，支付子域可继续拆分为收款和付款子子域。拆到一定程度后，有些子子域的领域边界就可能完成限界上下文的边界了。理论上限界上下文就是微服务的边界。**我们将限界上下文内的领域模型映射到微服务，就完成了。**

## 总结

- 通用语言确定了项目团队内部交流的统一语言，而这个语言所在的语义环境则是由限界上下文来限定的，以确保语义的唯一性
- 而领域专家、架构师和开发人员的主要工作就是通过事件风暴来划分限界上下文。限界上下文确定了微服务的设计和拆分方向，是微服务设计和拆分的主要依据。
- 只有理解了限界上下文的真正涵义以及它在微服务设计中的作用，才能真正发挥 DDD 的价值，这是基础也是前提



