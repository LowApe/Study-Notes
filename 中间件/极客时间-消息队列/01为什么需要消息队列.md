# 为什么需要消息队列？

> 消息队列是在消息的传输过程中保存消息的容器。

## 哪些问题适合使用消息队列来解决？

### 1. 异步处理

大多数程序员在面试中，被问过经典却没有准确答案的问题：如何设计一个秒杀系统？但大多数答案中都离不开消息队列

秒杀系统需要解决的核心问题是。如何**利用有限的服务器资源**，尽可能多地处理**短时间内的海量请求**

秒杀包含步骤：

- **风险控制**
- **库存锁定**
- 生成订单
- 短信通知
- 更新统计数据

如果没有优化，正常的处理流程是：App 将请求发送给网关，依次调用上述 5 个流程，然后将返回结果给 APP

![image.png](http://ww1.sinaimg.cn/large/006rAlqhly1g8l5brag0ej30y80a6421.jpg)

处理一个秒杀请求，从 5个步骤减少为 2 个 步骤，这样不仅响应速度更快，并且在秒杀期间，我们可以把大量的服务器资源用来处理秒杀请求。秒杀结束后再把资源用于处理后面的步骤，充分利用有限的服务器资源处理更多的秒杀请求

在这个场景中，**消息队列被用于实现服务的异步处理**这样做的好处是:

- 可以更快地返回结果
- 减少等待，自然实现了步骤之间的并发

### 2. 流量控制

如何避免过多的请求压垮我们的秒杀系统？

一个设计**健壮的**程序有自我保护的能力，也就是说，它应该可以在海量的请求下，还能在自身能力范围内尽可能多地处理请求，拒绝处理不了的请求并且保证自身运行正常。我们需要设计一套足够健壮的架构来将后端的服务保护起来。我们的设计思路，**使用消息队列隔离网关和后端服务，以达到流量控制和保护后端服务的目的**

1. 网管在收到请求后，将请求放到消息队列
2. 后端服务从请求消息队列中获取App请求，完成秒杀处理，然后返回结果

![image.png](http://ww1.sinaimg.cn/large/006rAlqhly1g8lq4mbr5gj30wg076tah.jpg)

秒杀开始后，当短时间大量的秒杀请求到达网关时，不会直接冲击到后端的秒杀服务，而是先堆积在消息队列中，后端按照自己的最大处理能力，从消息队列中**消费请求**进行处理

对于超时的请求可以直接丢弃，APP将超时无响应的请求处理为秒杀失败即可。运维人员还可以随时**增加秒杀服务的实例数量进行水平扩容**，而不用对系统的其他部分做任何更改

这种设计的优点是：能根据下游的处理能力自动调节流量，这样做同样是有代价的：

- 增加了系统调用链环节，导致总体的响应增加了系统调用链环节，导致总体的**响应时延变长**
- 上下游系统都要将同步调用改为异步消息，增加了系统的复杂度

如果我们能**预估出秒杀服务的处理能力**，就可以用消息队列实现一个令牌桶，更简单地进行流量控制。

> 令牌桶控制流量的原理是：单位时间内只发放固定数量的令牌到令牌桶中，规定服务在处理请求之前必须先从令牌桶中拿出一个令牌，如果令牌桶中没有令牌，则拒绝请求。这样保证单位时间内，能处理的请求不超过**发放令牌的数据**，起到了流量控制的作用

![image.png](http://ww1.sinaimg.cn/large/006rAlqhly1g8lqivfyrlj30xi0b8tfn.jpg)

令牌发生器按照预估的处理能力，匀速生产令牌并放入令牌队列(如果队列满了则丢弃令牌)，网关在收到请求时去令牌队列消费一个令牌，获取到令牌则继续调用后端秒杀服务，如果获取不到令牌则直接返回秒杀失败

### 3. 服务解耦

消息队列的另外一个作用，就是实现系统应用之间的解耦。我门知道订单是电商系统中比较核心的数据，当一个新订单创建时：

1. 支付系统需要发起支付流程
2. 风控系统需要审核订单的合法性
3. 客户系统需要给用户发短信告知用户
4. 经营分析系统需要更新统计数据
5. .....

这些订单下游的系统都需要实时获取订单数据。随着业务不断发展，这些订单下游系统不断的增加，不断变化，应对不断增加变化的下游系统，不停地修改调试订单系统与这些下游系统的接口。任何一个下游系统**接口变更**，都需要订单模块重新进行一次上线，对于一个电商的核心服务来说，这几乎是不可接受的

所有的电商都选择用消息队列来解决类似的系统耦合过于紧密的问题。引入消息队列后，订单服务在订单变化时发送一条消息到消息队列的一个主题 Order 中，所有下游系统都订阅主题 Order，这样每个下游系统都可以获得一份实时完整的订单数据。

## 小结

除了异步处理、流量控制和服务解耦，还包括

- 作为发布/订阅系统实现一个微服务级系统间的观察者模式
- 连接流计算任务和数据
- 用于将消息广播给大量接受者

在单体应用里面用队列解决的问题，在分布式系统中大多都可以使用消息队列来解决

同时消息队列有它自身的一些问题和局限性，包括：

- 引入消息队列带来的延迟问题
- 增加了系统的复杂度
- 可能产生数据不一致的问题

