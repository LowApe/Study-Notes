# Docker 实战案例

# 操作系统

目前常用的 Linux 发行版主要包括 `Debian/Ubuntu`系列和 `CentOS/Fedora` 系列。前者以自带软件包版本新而出名；后者则宣称运行更稳定一些。本节介绍：

- BusyBox 安装
- Alphine 安装
- Debian/Ubuntu 安装
- CentOS/Fedora 安装

## BusyBox

```shell
# 搜索 busybox
$ docker search busybox
# 下载镜像
$ docker pull busybox:latest
# 查看下载的镜像
$ docker images 
# 启动一个 busybox 容器，并在容器内查看挂载信息
$ docker run -it busybox
```

## Alphine



## Debian/Ubuntu

- Debian 是由 GPL 和其他自由软件许可协议授权的自由软件组成的操作系统。
- Ubuntu 是一个以桌面应用为主的 GNU/Linux 操作系统，基于 Debian 发行版和 GNONME/Unity 桌面环境

```shell
$ docker search -s 100 ubuntu
$ docker pull ubuntu:latest
$ docker run -it ubuntu /bin/bash
# 进入 ubuntu bash 命令状态
```

## CentOS/Fedora

- CentOS 基于 Redhat 的常见 Linux 分支

```shell
$ docker search -f stars=1000 centos
$ docker pull centos
$ docker run -it centos bash
```

> 注意⚠️：
>
> - 官方镜像体积都比较小，只带有一些基本的组件。
> - 处于安全考虑，几乎所有官方制作的镜像都没有安装 SSH 服务，无法使用用户名和密码直接登录

# 为镜像镜像添加 SSH 服务

前面介绍了进入容器的办法，比如 attach、exec等命令，但是这些命令都无法解决远程管理容器的问题。因此，当读者需要远程登录到容器内进行一些操作的时候，就需要 SSH 的支持了。本节介绍两种创建容器的方法：

- 基于 docker commit 命令创建
- 基于 Dockerfile 创建

## 基于 commit 命令创建

Docker 提供了 docker commit 命令，支持用户提交自己对指定容器的修改，并生成新的镜像。命令格式为`docker commit CONTAINER[repository:[:tag]]`

### 1 准备工作

使用 ubuntu 镜像来创建一个容器

```shell
$ docker run -it ubuntu /bin/bash
# apt-get 更新安装包
root@6579aae5e418:/# apt-get update
# apt-get 安装 openssh-server
root@6579aae5e418:/# apt-get install openssh-server -y
```

### 2 安装和配置ssh服务

如果需要正常启动 SSH 服务，则目录 `/var/run/sshd`必须存在。

```shell
root@6579aae5e418:/var/run# mkdir -p sshd
# 启动 ssh
root@6579aae5e418:/var/run# /usr/sbin/sshd -D &
```

查看此时容器的 22 端口 (SSH 服务默认监听的端口)，可见此端口已经处于监听状态：

```shell
# 下载网络查看工具
root@6579aae5e418:/var/run# apt-get install net-tool
# 查看端口监听状态
root@6579aae5e418:/var/run# netstat -tunlp
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      4202/sshd: /usr/sbi
tcp6       0      0 :::22                   :::*                    LISTEN      4202/sshd: /usr/sbi
# 修改 ssh 服务的安全登录配置，取消 pam 登录限制：🤔这下面命令看不懂
$ vim /etc/pam.d/sshd
# 注释 session required pam_loginuid.so/g'  /etc/pam.d/sshd
# 或者下面的
$ sed -ri 's/session required pam_loginuid.so/#session required pam_loginuid.so/g'  /etc/pam.d/sshd
```

在 root 用户目录下创建 .ssh 目录，并复制需要登录的公钥信息（一般为本地主机用户目录下的 `.ssh/id_rsa.pub`文件,可由 `ssh-keygen -t rsa`命令生成）到 `authorized_keys`文件中：

```shell
root@6579aae5e418:~# mkdir .ssh
root@6579aae5e418:~# ssh-keygen -t rsa
# 创建 authorized_keys 并且将 id_rsa.pub 复制到 authorized_keys 文件中
```

创建自动启动 SSH 服务的可执行文件 `run.sh`，并添加可执行权限：

```shell
$ vim /run.sh
# 内容
#!/bin/bash
/usr/sbin/sshd -D
# 保存推出后修改权限
$ chmod +x run.sh
# 退出容器
$ exit
```

### 3 保存镜像

将所退出的容器用 `docker commit`命令保存为一个新的 `sshd:ubuntu`镜像：

```shell
$ docker commit 6579aae5e418  sshd:ubuntu
sha256:1eff92f7fc01661acc3aaf9f1d977de48794c0108abf89b0672edc20606f1968
# 目前拥有的镜像
$ docker images 
```

### 4 使用镜像

启动容器，并添加端口映射 `10022-->22`其中 10022 宿主主机的端口，22 是容器的 SSH 服务监听端口：

```shell
$ docker run -p 10022:22 -d sshd:ubuntu /run.sh
$ docker ps 
root@iZuf6aytwpcvzkwiisgaxaZ:~# docker ps
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS                   NAMES
8c52843fbb89        sshd:ubuntu         "/root/run.sh"      5 seconds ago       Up 3 seconds        0.0.0.0:10022->22/tcp   infallible_lamport
# 在宿主主机 或其他主机上，通过 SSH 访问 10022 端口来访问容器
$ ssh userName@ipAddress -p 10022
```

**问题**

> 如果登录权限拒绝，确保密码正确，应该是docker 容器里的 root 登录权限没有开。
>
> - `vi /etc/ssh/sshd_config`
> - 编辑 `PermitRootLogin yes`
> - ` /etc/init.d/ssh restart`重启退出
>
> - [参考地址](https://www.cnblogs.com/yixius/articles/6971054.html)



## 使用 Dockerfile 创建

### 1 创建工作目录

首先，创建一个 

