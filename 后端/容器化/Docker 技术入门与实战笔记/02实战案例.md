# Docker å®æˆ˜æ¡ˆä¾‹

# æ“ä½œç³»ç»Ÿ

ç›®å‰å¸¸ç”¨çš„ Linux å‘è¡Œç‰ˆä¸»è¦åŒ…æ‹¬ `Debian/Ubuntu`ç³»åˆ—å’Œ `CentOS/Fedora` ç³»åˆ—ã€‚å‰è€…ä»¥è‡ªå¸¦è½¯ä»¶åŒ…ç‰ˆæœ¬æ–°è€Œå‡ºåï¼›åè€…åˆ™å®£ç§°è¿è¡Œæ›´ç¨³å®šä¸€äº›ã€‚æœ¬èŠ‚ä»‹ç»ï¼š

- BusyBox å®‰è£…
- Alphine å®‰è£…
- Debian/Ubuntu å®‰è£…
- CentOS/Fedora å®‰è£…

## BusyBox

```shell
# æœç´¢ busybox
$ docker search busybox
# ä¸‹è½½é•œåƒ
$ docker pull busybox:latest
# æŸ¥çœ‹ä¸‹è½½çš„é•œåƒ
$ docker images 
# å¯åŠ¨ä¸€ä¸ª busybox å®¹å™¨ï¼Œå¹¶åœ¨å®¹å™¨å†…æŸ¥çœ‹æŒ‚è½½ä¿¡æ¯
$ docker run -it busybox
```

## Alphine



## Debian/Ubuntu

- Debian æ˜¯ç”± GPL å’Œå…¶ä»–è‡ªç”±è½¯ä»¶è®¸å¯åè®®æˆæƒçš„è‡ªç”±è½¯ä»¶ç»„æˆçš„æ“ä½œç³»ç»Ÿã€‚
- Ubuntu æ˜¯ä¸€ä¸ªä»¥æ¡Œé¢åº”ç”¨ä¸ºä¸»çš„ GNU/Linux æ“ä½œç³»ç»Ÿï¼ŒåŸºäº Debian å‘è¡Œç‰ˆå’Œ GNONME/Unity æ¡Œé¢ç¯å¢ƒ

```shell
$ docker search -s 100 ubuntu
$ docker pull ubuntu:latest
$ docker run -it ubuntu /bin/bash
# è¿›å…¥ ubuntu bash å‘½ä»¤çŠ¶æ€
```

## CentOS/Fedora

- CentOS åŸºäº Redhat çš„å¸¸è§ Linux åˆ†æ”¯

```shell
$ docker search -f stars=1000 centos
$ docker pull centos
$ docker run -it centos bash
```

> æ³¨æ„âš ï¸ï¼š
>
> - å®˜æ–¹é•œåƒä½“ç§¯éƒ½æ¯”è¾ƒå°ï¼Œåªå¸¦æœ‰ä¸€äº›åŸºæœ¬çš„ç»„ä»¶ã€‚
> - å¤„äºå®‰å…¨è€ƒè™‘ï¼Œå‡ ä¹æ‰€æœ‰å®˜æ–¹åˆ¶ä½œçš„é•œåƒéƒ½æ²¡æœ‰å®‰è£… SSH æœåŠ¡ï¼Œæ— æ³•ä½¿ç”¨ç”¨æˆ·åå’Œå¯†ç ç›´æ¥ç™»å½•

# ä¸ºé•œåƒé•œåƒæ·»åŠ  SSH æœåŠ¡

å‰é¢ä»‹ç»äº†è¿›å…¥å®¹å™¨çš„åŠæ³•ï¼Œæ¯”å¦‚ attachã€execç­‰å‘½ä»¤ï¼Œä½†æ˜¯è¿™äº›å‘½ä»¤éƒ½æ— æ³•è§£å†³è¿œç¨‹ç®¡ç†å®¹å™¨çš„é—®é¢˜ã€‚å› æ­¤ï¼Œå½“è¯»è€…éœ€è¦è¿œç¨‹ç™»å½•åˆ°å®¹å™¨å†…è¿›è¡Œä¸€äº›æ“ä½œçš„æ—¶å€™ï¼Œå°±éœ€è¦ SSH çš„æ”¯æŒäº†ã€‚æœ¬èŠ‚ä»‹ç»ä¸¤ç§åˆ›å»ºå®¹å™¨çš„æ–¹æ³•ï¼š

- åŸºäº docker commit å‘½ä»¤åˆ›å»º
- åŸºäº Dockerfile åˆ›å»º

## åŸºäº commit å‘½ä»¤åˆ›å»º

Docker æä¾›äº† docker commit å‘½ä»¤ï¼Œæ”¯æŒç”¨æˆ·æäº¤è‡ªå·±å¯¹æŒ‡å®šå®¹å™¨çš„ä¿®æ”¹ï¼Œå¹¶ç”Ÿæˆæ–°çš„é•œåƒã€‚å‘½ä»¤æ ¼å¼ä¸º`docker commit CONTAINER[repository:[:tag]]`

### 1 å‡†å¤‡å·¥ä½œ

ä½¿ç”¨ ubuntu é•œåƒæ¥åˆ›å»ºä¸€ä¸ªå®¹å™¨

```shell
$ docker run -it ubuntu /bin/bash
# apt-get æ›´æ–°å®‰è£…åŒ…
root@6579aae5e418:/# apt-get update
# apt-get å®‰è£… openssh-server
root@6579aae5e418:/# apt-get install openssh-server -y
```

### 2 å®‰è£…å’Œé…ç½®sshæœåŠ¡

å¦‚æœéœ€è¦æ­£å¸¸å¯åŠ¨ SSH æœåŠ¡ï¼Œåˆ™ç›®å½• `/var/run/sshd`å¿…é¡»å­˜åœ¨ã€‚

```shell
root@6579aae5e418:/var/run# mkdir -p sshd
# å¯åŠ¨ ssh
root@6579aae5e418:/var/run# /usr/sbin/sshd -D &
```

æŸ¥çœ‹æ­¤æ—¶å®¹å™¨çš„ 22 ç«¯å£ (SSH æœåŠ¡é»˜è®¤ç›‘å¬çš„ç«¯å£)ï¼Œå¯è§æ­¤ç«¯å£å·²ç»å¤„äºç›‘å¬çŠ¶æ€ï¼š

```shell
# ä¸‹è½½ç½‘ç»œæŸ¥çœ‹å·¥å…·
root@6579aae5e418:/var/run# apt-get install net-tool
# æŸ¥çœ‹ç«¯å£ç›‘å¬çŠ¶æ€
root@6579aae5e418:/var/run# netstat -tunlp
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      4202/sshd: /usr/sbi
tcp6       0      0 :::22                   :::*                    LISTEN      4202/sshd: /usr/sbi
# ä¿®æ”¹ ssh æœåŠ¡çš„å®‰å…¨ç™»å½•é…ç½®ï¼Œå–æ¶ˆ pam ç™»å½•é™åˆ¶ï¼šğŸ¤”è¿™ä¸‹é¢å‘½ä»¤çœ‹ä¸æ‡‚
$ vim /etc/pam.d/sshd
# æ³¨é‡Š session required pam_loginuid.so/g'  /etc/pam.d/sshd
# æˆ–è€…ä¸‹é¢çš„
$ sed -ri 's/session required pam_loginuid.so/#session required pam_loginuid.so/g'  /etc/pam.d/sshd
```

åœ¨ root ç”¨æˆ·ç›®å½•ä¸‹åˆ›å»º .ssh ç›®å½•ï¼Œå¹¶å¤åˆ¶éœ€è¦ç™»å½•çš„å…¬é’¥ä¿¡æ¯ï¼ˆä¸€èˆ¬ä¸ºæœ¬åœ°ä¸»æœºç”¨æˆ·ç›®å½•ä¸‹çš„ `.ssh/id_rsa.pub`æ–‡ä»¶,å¯ç”± `ssh-keygen -t rsa`å‘½ä»¤ç”Ÿæˆï¼‰åˆ° `authorized_keys`æ–‡ä»¶ä¸­ï¼š

```shell
root@6579aae5e418:~# mkdir .ssh
root@6579aae5e418:~# ssh-keygen -t rsa
# åˆ›å»º authorized_keys å¹¶ä¸”å°† id_rsa.pub å¤åˆ¶åˆ° authorized_keys æ–‡ä»¶ä¸­
```

åˆ›å»ºè‡ªåŠ¨å¯åŠ¨ SSH æœåŠ¡çš„å¯æ‰§è¡Œæ–‡ä»¶ `run.sh`ï¼Œå¹¶æ·»åŠ å¯æ‰§è¡Œæƒé™ï¼š

```shell
$ vim /run.sh
# å†…å®¹
#!/bin/bash
/usr/sbin/sshd -D
# ä¿å­˜æ¨å‡ºåä¿®æ”¹æƒé™
$ chmod +x run.sh
# é€€å‡ºå®¹å™¨
$ exit
```

### 3 ä¿å­˜é•œåƒ

å°†æ‰€é€€å‡ºçš„å®¹å™¨ç”¨ `docker commit`å‘½ä»¤ä¿å­˜ä¸ºä¸€ä¸ªæ–°çš„ `sshd:ubuntu`é•œåƒï¼š

```shell
$ docker commit 6579aae5e418  sshd:ubuntu
sha256:1eff92f7fc01661acc3aaf9f1d977de48794c0108abf89b0672edc20606f1968
# ç›®å‰æ‹¥æœ‰çš„é•œåƒ
$ docker images 
```

### 4 ä½¿ç”¨é•œåƒ

å¯åŠ¨å®¹å™¨ï¼Œå¹¶æ·»åŠ ç«¯å£æ˜ å°„ `10022-->22`å…¶ä¸­ 10022 å®¿ä¸»ä¸»æœºçš„ç«¯å£ï¼Œ22 æ˜¯å®¹å™¨çš„ SSH æœåŠ¡ç›‘å¬ç«¯å£ï¼š

```shell
$ docker run -p 10022:22 -d sshd:ubuntu /run.sh
$ docker ps 
root@iZuf6aytwpcvzkwiisgaxaZ:~# docker ps
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS                   NAMES
8c52843fbb89        sshd:ubuntu         "/root/run.sh"      5 seconds ago       Up 3 seconds        0.0.0.0:10022->22/tcp   infallible_lamport
# åœ¨å®¿ä¸»ä¸»æœº æˆ–å…¶ä»–ä¸»æœºä¸Šï¼Œé€šè¿‡ SSH è®¿é—® 10022 ç«¯å£æ¥è®¿é—®å®¹å™¨
$ ssh userName@ipAddress -p 10022
```

**é—®é¢˜**

> å¦‚æœç™»å½•æƒé™æ‹’ç»ï¼Œç¡®ä¿å¯†ç æ­£ç¡®ï¼Œåº”è¯¥æ˜¯docker å®¹å™¨é‡Œçš„ root ç™»å½•æƒé™æ²¡æœ‰å¼€ã€‚
>
> - `vi /etc/ssh/sshd_config`
> - ç¼–è¾‘ `PermitRootLogin yes`
> - ` /etc/init.d/ssh restart`é‡å¯é€€å‡º
>
> - [å‚è€ƒåœ°å€](https://www.cnblogs.com/yixius/articles/6971054.html)



## ä½¿ç”¨ Dockerfile åˆ›å»º

### 1 åˆ›å»ºå·¥ä½œç›®å½•

é¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ª 

