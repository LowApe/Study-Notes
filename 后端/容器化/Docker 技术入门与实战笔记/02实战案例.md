# Docker 实战案例

# 操作系统

目前常用的 Linux 发行版主要包括 `Debian/Ubuntu`系列和 `CentOS/Fedora` 系列。前者以自带软件包版本新而出名；后者则宣称运行更稳定一些。本节介绍：

- BusyBox 安装
- Alphine 安装
- Debian/Ubuntu 安装
- CentOS/Fedora 安装

## BusyBox

```shell
# 搜索 busybox
$ docker search busybox
# 下载镜像
$ docker pull busybox:latest
# 查看下载的镜像
$ docker images 
# 启动一个 busybox 容器，并在容器内查看挂载信息
$ docker run -it busybox
```

## Alphine



## Debian/Ubuntu

- Debian 是由 GPL 和其他自由软件许可协议授权的自由软件组成的操作系统。
- Ubuntu 是一个以桌面应用为主的 GNU/Linux 操作系统，基于 Debian 发行版和 GNONME/Unity 桌面环境

```shell
$ docker search -s 100 ubuntu
$ docker pull ubuntu:latest
$ docker run -it ubuntu /bin/bash
# 进入 ubuntu bash 命令状态
```

## CentOS/Fedora

- CentOS 基于 Redhat 的常见 Linux 分支

```shell
$ docker search -f stars=1000 centos
$ docker pull centos
$ docker run -it centos bash
```

> 注意⚠️：
>
> - 官方镜像体积都比较小，只带有一些基本的组件。
> - 处于安全考虑，几乎所有官方制作的镜像都没有安装 SSH 服务，无法使用用户名和密码直接登录

# 为镜像镜像添加 SSH 服务

前面介绍了进入容器的办法，比如 attach、exec等命令，但是这些命令都无法解决远程管理容器的问题。因此，当读者需要远程登录到容器内进行一些操作的时候，就需要 SSH 的支持了。本节介绍两种创建容器的方法：

- 基于 docker commit 命令创建
- 基于 Dockerfile 创建

## 基于 commit 命令创建

Docker 提供了 docker commit 命令，支持用户提交自己对指定容器的修改，并生成新的镜像。命令格式为`docker commit CONTAINER[repository:[:tag]]`

### 1 准备工作

使用 ubuntu 镜像来创建一个容器

```shell
$ docker run -it ubuntu /bin/bash
# apt-get 更新安装包
root@6579aae5e418:/# apt-get update
# apt-get 安装 openssh-server
root@6579aae5e418:/# apt-get install openssh-server -y
```

### 2 安装和配置ssh服务

如果需要正常启动 SSH 服务，则目录 `/var/run/sshd`必须存在。

```shell
root@6579aae5e418:/var/run# mkdir -p sshd
# 启动 ssh
root@6579aae5e418:/var/run# /usr/sbin/sshd -D &
```

查看此时容器的 22 端口 (SSH 服务默认监听的端口)，可见此端口已经处于监听状态：

```shell
# 下载网络查看工具
root@6579aae5e418:/var/run# apt-get install net-tool
# 查看端口监听状态
root@6579aae5e418:/var/run# netstat -tunlp
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      4202/sshd: /usr/sbi
tcp6       0      0 :::22                   :::*                    LISTEN      4202/sshd: /usr/sbi
# 修改 ssh 服务的安全登录配置，取消 pam 登录限制：🤔这下面命令看不懂
$ vim /etc/pam.d/sshd
# 注释 session required pam_loginuid.so/g'  /etc/pam.d/sshd
# 或者下面的
$ sed -ri 's/session required pam_loginuid.so/#session required pam_loginuid.so/g'  /etc/pam.d/sshd
```

在 root 用户目录下创建 .ssh 目录，并复制需要登录的公钥信息（一般为本地主机用户目录下的 `.ssh/id_rsa.pub`文件,可由 `ssh-keygen -t rsa`命令生成）到 `authorized_keys`文件中：

```shell
root@6579aae5e418:~# mkdir .ssh
root@6579aae5e418:~# ssh-keygen -t rsa
# 创建 authorized_keys 并且将 id_rsa.pub 复制到 authorized_keys 文件中
```

创建自动启动 SSH 服务的可执行文件 `run.sh`，并添加可执行权限：

```shell
$ vim /run.sh
# 内容
#!/bin/bash
/usr/sbin/sshd -D
# 保存推出后修改权限
$ chmod +x run.sh
# 退出容器
$ exit
```

### 3 保存镜像

将所退出的容器用 `docker commit`命令保存为一个新的 `sshd:ubuntu`镜像：

```shell
$ docker commit 6579aae5e418  sshd:ubuntu
sha256:1eff92f7fc01661acc3aaf9f1d977de48794c0108abf89b0672edc20606f1968
# 目前拥有的镜像
$ docker images 
```

### 4 使用镜像

启动容器，并添加端口映射 `10022-->22`其中 10022 宿主主机的端口，22 是容器的 SSH 服务监听端口：

```shell
$ docker run -p 10022:22 -d sshd:ubuntu /root/run.sh
$ docker ps 
root@iZuf6aytwpcvzkwiisgaxaZ:~# docker ps
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS                   NAMES
8c52843fbb89        sshd:ubuntu         "/root/run.sh"      5 seconds ago       Up 3 seconds        0.0.0.0:10022->22/tcp   infallible_lamport
# 在宿主主机 或其他主机上，通过 SSH 访问 10022 端口来访问容器
$ ssh userName@ipAddress -p 10022
```

通过 ifconfig 找到 docker 的网络地址

**问题**

> 如果登录权限拒绝，确保密码正确，应该是docker 容器里的 root 登录权限没有开。
>
> - `vi /etc/ssh/sshd_config`
> - 编辑 `PermitRootLogin yes`
> - ` /etc/init.d/ssh restart`重启退出
>
> - [参考地址](https://www.cnblogs.com/yixius/articles/6971054.html)



## 使用 Dockerfile 创建

### 1 创建工作目录

首先，创建一个  sshd_ubuntu 工作目录:

```shell
$ mkdir sshd_ubuntu
$ cd sshd_ubuntu
# 创建 Dockerfile 和 run.sh 文件
$ touch Dockerfile run.sh

```

### 2 编写 run.sh 脚本和 authorized_keys 文件

脚本文件：

```shell
#!/bin/bash
/usr/sbin/sshd -D
```

在宿主机上生成 SSH 密钥对，并创建 `authorized_keys`文件：

```shell
$ ssh-keygen -t rsa
$ cat ~/.ssh/id_rsa.pub > authorized_keys
```

### 3 编写 Dockerfile

下面是 Dockerfile 的内容及各部分的注释，可以对比上一节中利用 docker commit 命令创建镜像过程，所进行的操作基本一致：

```dockerfile
# 设置继承镜像
FROM ubuntu:14.04
# 提供一些作者的信息
MAINTAINER docker_user(user@docker.com)
# 下面开始运行更新命令
RUN apt-get update
# 安装 ssh 服务
RUN apt-get install -y openssh-server
RUN mkdir -p /var/run/sshd
RUN mkdir -p /root/.ssh
# 取消 pam 限制
RUN sed -ri 's/session required pam_loginuid.so/#session required
	pam_loginuid.so/g' /etc/pam.d/sshd
# 复制配置文件到相应位置，并赋予脚本可执行权限
ADD authorized_keys /root/.ssh/authorized_keys
ADD run.sh /root/run.sh
RUN chmod 755 /root/run.sh
# 开放端口
EXPOSE 22
# 设置自启动命令
CMD ["/run.sh"]
```

### 4 创建镜像

在 sshd_ubuntu 目录下，使用 docker build 命令来创建镜像。这里需要注意最后还有一个`"."`，表示使用当前目录中的 Dockerfile:

```shell
$ cd sshd_ubuntu
$ docker build -t sshd:Dockerfile .
Sending build context to Docker daemon  4.096kB
Step 1/12 : FROM ubuntu:latest
 ---> f643c72bc252
Step 2/12 : MAINTAINER docker_user(user@docker.com)
 ---> Running in 903e005f29f7
Removing intermediate container 903e005f29f7
 ---> 52f880d66ef5
Step 3/12 : RUN apt-get update
...
Successfully built 5101ebcb66b6
Successfully tagged sshd:Dockerfile
```

如果读者使用 Dockerfile 创建自定义镜像，那么需要注意的是 Docker 会自动删除中间临时创建的层，还需要注意每一步的操作和编写的 Dockerfile 中命令的对应关系

```shell
# 查看 sshd: Dockerfile 镜像已存在:
$ docker images
```

### 5 测试镜像，运行容器

使用刚才创建的 sshd: Dockerfile 镜像来运行一个容器

直接启动镜像，映射容器的 22 端口到本地的 xxx 端口：

```shell
# 运行
$ docker run -d -p xxx:22 sshd:Dockerfile /root/run.sh
# 连接测试
ssh user@ip -p xxx
```

# Web服务与应用

本章介绍Web服务器：

- Apache 
- Nginx
- Tomcat

本章会展示两种创建镜像的过程。其中一些操作比较简单的镜像使用 Dockerfile 来创建，而像 Weblogic 这样复杂的应用，则使用 commit 方式来创建，读者可根据自己的需求进行选择。

## Apache

Apache 是一个高稳定性的、商业级别的开源 Web 服务器。目前 Apache 已经是世界使用排名第一的 Web 服务器软件。

### 1 使用官方镜像

编写 Dockerfile 

```dockerfile

```

...

## Nginx 

Nginx 是一款功能强大的开源反向代理服务器,支持 HTTP、HTTPS、SMTP、POP3、IMAP 等协议。它也可以作为负载均衡器、HTTP缓存或 Web 服务器。 **Nginx 一开始就专注于高并发和高性能的应用场景**

### 1 使用官方镜像

用户可以使用 `docker run`命令直接运行官方 Nginx 镜像：

```shell
$ docker run -d -p xxx:80 --name webserver nginx
```

> xxx 表示宿主机端口

![image.png](http://ww1.sinaimg.cn/large/006rAlqhgy1glvasw0f5xj30uu0baq4h.jpg)

### 2 自定义 Web 页面

同样的，创建 `index.html`文件，并将 `index.html`文件挂载至容器中，即可看到显示自定义的页面.可以根据`docker exec -it containerId /bin/bash`进入容器，然后修改下面路径 `index.html`文件。然后重启`docker resart xxx`

```shell
# 没试过这
$ docker run --name nginx-container -p xxx:80 -v index.html:/usr/share/nginx/ 
html:ro -d nginx
```

另外，也可以使用 Dockerfile 来构建新镜像。Dockerfile 内容:其中`./index.html `是宿主机的文件

```dockerfile
FROM nginx
COPY ./index.html /usr/share/nginx/html
```

开始构建镜像 `my-nginx`:

```sh
$ docker build -t my-nginx .
# 构建成功后执行 docker run
$ docker run --name nginx-container -d my-nginx
```

## Tomcat

Tomcat 是由 Apache 软件基金会下属的 Jakarta 项目开发的一个 Servlet 容器。它提供了作为 Web 服务器的一些特有功能，如 Tomcat 管理和控制平台、安全域管理和 Tomcat 阀等。由于 Tomcat 本省也内含了一个 HTTP 服务器，也可以当作一个单独的 Web 服务器来使用

## Jetty

Jetty  是一个优秀的开源 Servlet 容器，相对老牌的 Tomcat ，Jetty 架构更合理，性能更优。尤其是启动速度上

## LAMP

Linux-Apache-MySQL-PHP 是目前流行的 Web 工具栈，其中包括: Linux 操作系统，Apache 网络服务器，MySQL 数据库，Perl、PHP 或者 Python 变成语言。LAMP 具有 Web 资源丰富、轻量、快速开发等特点；和微软的 `.NET`架构相比，LAMP 更具有通用、跨平台、高性能、低价格的优势。因此 LAMP 在性能、质量还是价格方面都是企业搭建网站的首选平台。 **现在有人用 Nginx 替换 Apache，称为 LNMP**并不会影响整个框架的选型原则

### 1 使用 linode/lamp 镜像

```shell
$ docker search -f stars=100 linode
$ docker pull linode
$ docker run -p xxx:80 -t -i linode/lamp /bin/bash
```

### 2 使用 tutum/lamp 镜像

首先，执行 `docker run` 指令，直接运行镜像:

```shell
$ docker run -d -p xxx:80 -p 3306:3306 tutum/lamp
```

## CMS

内容管理系统指的是提供内容编辑服务的平台程序。流行的 CMS 软件为例

### WordPress

WordPress 是风靡全球的开源内容管理系统，是博客、企业官网、产品首页等内容相关平台的主流实现方案之一。WordPress 基于 PHP 和 MySQL，支持主题，插件和各种功能模块

**使用官方镜像**

首先，通过 Docker Hub 下载官方 wordpress 镜像：

```shell
$ docker pull wordpress
```

然后，就可以创建并运行一个 wordpress 容器，并连接到 mysql 容器

```shell
# 创建并运行一个 wordpress 容器，并连接到 mysql 容器
$ docker  run --name some-wordpress --link some-mysql:mysql -p xxx:80
-d wordpress
```

**使用 Compose 搭建 WordPress 应用**

可以使用 Compose 来一键搭建 WordPress 应用.新建 `docker-compose.yml`文件：

```yaml
wordpress:
	image: wordpress
	links:
		- db:mysql
    ports:
    	- 8080:80
db:
	image: mariadb
	environment:
		MYSQL_ROOT_PASSWORD:example
```

```shell
$ docker-compose up
```

> 如果提示没有 docker-compose 命令，可以通过 `pip install docker-compose`来在线安装（`apt install docker-compose`）

待服务启动后，即可打开游览器访问本地 80 端口打开 Wordpress 配置界面

### Ghost

## 持续开发与管理

> 持续集成(Continuous integration,CI) 正是针对这类问题的一种开发实践，它倡导开发团队定期进行集成验证。**集成通过自动化的构建来完成，包括自动编译、发布和测试，从而尽快地发现错误**
>
> 持续集成特点：从检出代码、编译构建、运行测试、结果记录、测试统计等都是自动完成的，减少人工干预。需要有持续集成系统的支持，包括代码托管机制支持，以及集成服务器等。
>
> 持续交付(Continuous delivery，CD) 则是经典的敏捷软件开发方法的自然延伸，它**强调产品在修改后到部署上线的流程要敏捷化，自动化**

### 1 Jenkins

开源软件项目，提供一个开发易用的持续集成平台 。**Jenkins 能实时监控集成中存在的错误，提供详细的日志文件和题型功能，并用图表的形式形象地展示项目的趋势和稳定性.** Jenkins 特点包括安装配置简单、支持详细的测试报表、分布式构建等

自 2.0 版本，Jenkins 推出了 `Pipeline as Code`,帮助 Jenkins 实现对 CI 和 CD 更好的支持。**通过 Pipeline,将原本独立运行的多个任务连接起来，可以实现十分复杂的发布流。**

```shell
$ docker run -p xxx:8080 -p xxxx:500000 jenkins
```

目前运行的容器中，数据会存储在工作目录 `/var/jenkins_home`中，这包括 `jenkins`中所有的数据，包括插件和配置信息等。如果需要数据持久化，，读者可以使用数据卷机制：

```shell
$ docker run -p xxx:xx -p xxx:xx -v /your/home:/var/jenkins_home jenkins
```

以上指令会将 Jenkins 数据存储于宿主机的 `/your/home`目录

### 2 Gitlab

Gitlabe 是一款非常强大的开源源码管理系统。它支持基于 Git 的源码管理、代码评审、issue跟踪、活动管理、wiki页面，持续集成和测试等功能。基于 Gitlab，用户可以自己搭建一套类似 Github 的开发协同平台. gitlab-ce 社区版

```shell
$ docker pull gitlab/gitlab-ce;
# 运行 Gitlab 官方提供社区版
$ docker run --detach \
--hostname localhost \
--publish 9876:443 --publish xxx:80 --publish xxx:22\
--name gitlab \
--restart always \
--volume /srv/gitlab/config:/etc/gitlab \
--volume /srv/gitlab/logs:/var/log/gitlab \
--volume /srv/gitlab/data:/var/opt/gitlab \
gitlab/gitlab-ce:latest
```

> - --hostname 访问地址
> - --publish 开放的端口： 443 用于HTTPS 80 网址 22 ssh
> - -- volume 数据卷 

## 小结

包括 Web 服务在内的中间件领域十分适合引入容器技术，原因如下：

- 中间件服务器是除数据库服务器外的主要计算节点，很容易成为性能瓶颈，所有通常需要大批量部署，而 Docker 对于批量部署有着许多先天的优势
- 中间件服务器结构清晰，在剥离了配置文件、日志、代码目录之后，这使得容器的迁移和批量部署更加方便
- 中间件服务器很容易实现集群，在使用硬件的 F5、软件的 Nginx等负载均衡后，中间件服务器集群变得非常容易

> 在实践过程中，读者需要注意数据的持久化。对于程序代码、程序的资源目录、日志、数据库文件、等需要实时更新的数据一定要通过`-v`参数映射到宿主主机的目录中来，避免发生数据丢失和带来性能下架

