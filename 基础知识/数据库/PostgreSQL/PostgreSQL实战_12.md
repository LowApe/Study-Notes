# ç‰©ç†å¤åˆ¶å’Œé€»è¾‘å¤åˆ¶

é€šè¿‡æµå¤åˆ¶æŠ€æœ¯ï¼Œå¯ä»¥ä»å®ä¾‹çº§å¤åˆ¶å‡ºä¸€ä¸ªä¸ä¸»åº“ä¸€æ‘¸ä¸€æ ·çš„ä»åº“ã€‚

ç‰©ç†å¤åˆ¶ï¼šæµå¤åˆ¶ï¼Œæ˜¯åŸºäºå®ä¾‹çº§çš„å¤åˆ¶ï¼Œåªèƒ½å¤åˆ¶æ•´ä¸ª PostgreSQLç¤ºä¾‹

é€»è¾‘å¤åˆ¶ï¼šä¹Ÿç§°ä¸ºé€‰æ‹©æ€§å¤åˆ¶ï¼Œé€»è¾‘å¤åˆ¶å¯ä»¥åšåˆ° **åŸºäºè¡¨çº§åˆ«çš„å¤åˆ¶**

WALï¼šWrite-Ahead Logging æ—¥å¿—è®°å½•æ•°æ®åº“çš„å˜åŒ–ï¼Œæ ¼å¼ä¸ºäºŒè¿›åˆ¶æ ¼å¼ï¼Œä¸»æœºæ–­ç”µï¼Œæ•°æ®æ²¡æ¥å¾—åŠåˆ·æ–°æ•°æ®æ–‡ä»¶ï¼Œå½“æ•°æ®åº“å†æ¬¡å¯åŠ¨æ—¶ä¼šæ ¹æ® WALæ—¥å¿—æ–‡ä»¶è¿›è¡Œäº‹åŠ¡å›æ»šï¼Œä»è€Œæ¢å¤æ•°æ®åº“åˆ°ä¸€è‡´æ€§çŠ¶æ€ã€‚**æµå¤åˆ¶æ˜¯åŸºäº WAL ç‰©ç†å¤åˆ¶ï¼Œé€»è¾‘å¤åˆ¶æ˜¯åŸºäº WAL é€»è¾‘è§£æï¼Œå°† WAL è§£ææˆä¸€ç§æ¸…æ™°ã€æ˜“äºç†è§£çš„æ ¼å¼**

**æµå¤åˆ¶å’Œé€»è¾‘å¤åˆ¶ä¸»è¦å·®å¼‚**

- æµå¤åˆ¶æ˜¯ç‰©ç†å¤åˆ¶ï¼Œå…¶æ ¸å¿ƒåŸç†æ˜¯ä¸»åº“å°†é¢„å†™æ—¥å¿— WAL æ—¥å¿—æµå‘é€ç»™å¤‡åº“ï¼Œå¤‡è€ƒæ¥æ”¶åˆ° WAL æ—¥å¿—æµåè¿›è¡Œé‡åšï¼Œå› æ­¤**æµå¤åˆ¶æ˜¯åŸºäº WAL æ—¥å¿—æ–‡ä»¶çš„ç‰©ç†å¤åˆ¶** ã€‚é€»è¾‘å¤åˆ¶æ ¸å¿ƒåŸç†ä¹Ÿæ˜¯åŸºäº WALï¼Œé€»è¾‘å¤åˆ¶ä¼šæ ¹æ®é¢„å…ˆè®¾ç½®å¥½çš„è§„åˆ™è§£æWAL æ—¥å¿—ï¼Œå°† WAL äºŒè¿›åˆ¶æ–‡ä»¶è§£ææˆä¸€å®šæ ¼å¼çš„é€»è¾‘å˜åŒ–ä¿¡æ¯ï¼Œæ¯”å¦‚ä» WAL ä¸­è§£ææŒ‡å®šè¡¨ä¸Šå‘ç”Ÿçš„ DML é€»è¾‘å˜åŒ–ä¿¡æ¯ï¼Œä¹‹åä¸»åº“å°†é€»è¾‘å˜åŒ–ä¿¡æ¯å‘é€ç»™å¤‡è€ƒï¼Œå¤‡è€ƒæ”¶åˆ° WAL é€»è¾‘è§£æä¿¡æ¯åå†åº”ç”¨æ—¥å¿—
- æµå¤åˆ¶åªèƒ½å¯¹ PostgreSQL å®ä¾‹çº§è¿›è¡Œå¤åˆ¶ï¼Œè€Œé€»è¾‘å¤åˆ¶èƒ½å¯¹æ•°æ®åº“è¡¨çº§è¿›è¡Œå¤åˆ¶ã€‚
- **æµå¤åˆ¶èƒ½å¯¹ DDL æ“ä½œè¿›è¡Œå¤åˆ¶ï¼Œæ¯”å¦‚ä¸»åº“ä¸Šæ–°å»ºè¡¨ã€ç»™å·²æœ‰è¡¨åŠ å‡å­—æ®µæ—¶ä¼šè‡ªåŠ¨åŒæ­¥åˆ°å¤‡åº“ï¼Œè€Œé€»è¾‘å¤åˆ¶ä¸»åº“ä¸Šçš„DDLæ“ä½œä¸ä¼šå¤åˆ¶åˆ°å¤‡åº“**
- æµå¤åˆ¶ä¸»åº“å¯è¯»å†™ï¼Œä½†ä»åº“åªå…è®¸æŸ¥è¯¢ä¸å…è®¸å†™å…¥ï¼Œè€Œé€»è¾‘å¤åˆ¶çš„ä»åº“å¯è¯»å†™
- æµå¤åˆ¶è¦æ±‚ PostgreSQL å¤§ç‰ˆæœ¬å¿…é¡»ä¸€è‡´ï¼Œé€»è¾‘å¤åˆ¶æ”¯æŒè·¨ PostgreSQL å¤§ç‰ˆæœ¬

# 1 å¼‚æ­¥æµå¤åˆ¶

å¼‚æ­¥æµå¤åˆ¶æ˜¯æŒ‡ä¸»åº“ä¸Šæäº¤äº‹åŠ¡æ—¶ä¸éœ€è¦ç­‰å¾…å¤‡åº“æ¥æ”¶ WAL æ—¥å¿—æµå¹¶å†™å…¥åˆ°å¤‡åº“ WALæ—¥å¿—æµä¾¿è¿”å›æˆåŠŸï¼Œè€ŒåŒæ­¥æµå¤åˆ¶ç›¸å

å¼‚æ­¥æµå¤åˆ¶éƒ¨ç½²æ–¹å¼ï¼š

- æ‹·è´æ•°æ®æ–‡ä»¶æ–¹å¼
- é€šè¿‡`pg_basebackup`å‘½ä»¤è¡Œå·¥å…·

## 1. æ‹·è´æ•°æ®æ–‡ä»¶æ–¹å¼éƒ¨ç½²æµå¤åˆ¶

è£…å¤‡ä¸¤å°ä¸»æœºæˆ–è™šæ‹Ÿæœºï¼Œåˆ†åˆ«ä½œä¸ºä¸»èŠ‚ç‚¹å’Œå¤‡ä»¶ç‚¹

> ğŸ¤”ï¼šå¦‚æœåªæœ‰ä¸€å°ç”µè„‘ï¼Œèƒ½ä¸èƒ½ä½¿ç”¨ docker è¿›è¡Œæ¨¡æ‹Ÿï¼Œå¾…éªŒè¯

```shell
# åˆ›å»ºæ“ä½œç³»ç»Ÿç”¨æˆ·å’Œç›¸å…³ç›®å½•
groupadd postgres
useradd postgres -g postgres
passwd postgres
# pg_root å­˜å‚¨æ•°æ®åº“ç³»ç»Ÿæ•°æ®æ–‡ä»¶
mkdir -p /database/pg10/pg_root
# pg_tbs å­˜å‚¨ç”¨æˆ·è‡ªå®šä¹‰è¡¨ç©ºé—´æ–‡ä»¶
mkdir -p /database/pg10/pg_tbs
chown -R postgres:postgres /databases/pg10
```

æµå¤åˆ¶é…ç½®å‚æ•°`postgresql.conf`,è®¾ç½®ä¸€ä¸‹å‚æ•°:

```properties
# minial ,replica , or logical WAL æ—¥å¿—è¾“å‡ºçº§åˆ«
wal_leve= replica 
# enables archiving;off,on,or always æ˜¯å¦å¯ç”¨ä¸ªå½’æ¡£
archive_mode = on 
# command to use to archive a logfile segment
archive_command ='/bin/date'
# max number of walsemder processes æœ€å¤§ WAL å‘é€è¿›ç¨‹
max_wal_senders = 10 
# in logfiel segments, 16 MB each; 0 disables/
wal_keep_segements = 512

```

