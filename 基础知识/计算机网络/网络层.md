# 网络层

## 4.1 网络层提供的两种服务
- 虚电路服务
- 数据报服务(TCP/IP)


设计思路:
1. 网络层向上只提供简单灵活、无连接、尽最大努力交付的数据报服务
2. 网络在发送分组时不需要先建立连接
3. 网络层不提供服务质量承诺

## 4.2 网际协议 IP
三个配套协议
1. 地址解析协议 ARP
2. 网际控制报文协议 ICMP
3. 网际组管理协议 IGMP

### 虚拟互连网络

将网络互相连接起来要使用一些中间设备，根据中间设备所在的层次,可以有以下四种不同的中间设备
1. **物理层**使用的中间件设备-**转发器**
2. **数据链路层**使用的中间件设备-**网桥或桥接器**
3. **网络层**使用的中间设备-**路由器**
4. **网络层以上**使用的中间设备-**网关**(网关连接两个不兼容的系统需要在高层进行协议转换)

现在讨论网路互连,指路由器进行网络互连和路由选择

### 4.2.2 分类的 IP 地址
IP 地址 32位的标识符
1. 分类的 IP 地址
2. 子网的划分
3. 构成超网

**分类的 IP 地址**

网络号(net-id)  主机号(host-id)

![](http://ww1.sinaimg.cn/large/006rAlqhly1fx8tzhz23qj307a05ct8l.jpg)

- ABC 类地址都是单播地址(一对一通信)
- ABC 类网络号字段分别为 1,2,3字节
- ABC 类主机号字段分别为 3,2,1字节
- D 类地址(前四位是1110) 用于多播(一对多通信)
- E 类地址(1111) 保留以后使用

![](http://ww1.sinaimg.cn/large/006rAlqhly1fx8u9ib3uuj30hp0a075j.jpg)

**常用的三种类别的IP地址**
> A类 (占总地址的一半)
- 网络号固定1位(0),剩余7位,2^7-2=126 (网络号全为0的IP地址是个保留地址-本网络)(011111保留地址作为本地软件环回地址-127.0.0.1)
- 主机号占3个字节,因此最大主机数 2^24-2=16777214 (全0的主机号字段表示本主机-5.0.0.0)(全1表示主机所在网络上的所有主机)

> B类 网络号字段2个字节(10),剩下 14 位，所以不可能有 全为 0 或全 1。这里不存在减 2。128.0.0.0 不指派,可以指派的最小地址128.1.0.1。2^14-1=16383.最大主机数 2^16-2 即
-2 扣除全部 0 和 1

> C类 地址有 3 字节的网络号(110),192.0.0.0 不指派,最小地址192.0.1.0

> IP 地址的指派范围

|网络类别|第一个网络号|最后一个网络号|
|:-----: |:-----:     |:-----:     |
|A|1|126|
|B|128.1|191.255|
|C|192.0.1|223.255.255|

**IP地址重要特点**

1. 分等级的地址结构。
    1. IP地址管理机构机构只分配网络号,主机号由网络号自行分配
    2. 路由器仅根据目的主机所连接的网络号来转发分组,减少路由表所占的存储空间以及查找路由表的存储空间以及查找路由表的时间


**IP地址与硬件地址**
- 物理地址是数据链路层和物理层使用的地址
- IP 地址是网络层和以上各层使用的地址,是一种逻辑地址
- 路由器只根据目的站的IP地址的网络号进行路由选择
- 在局域网的链路层,只能看见 MAC 帧,IP数据报被封装在 MAC  帧中

### 4.2.4 地址解析协议 ARP
ARP 协议的用途是从网络层使用的IP地址解析出在数据链路层使用的硬件地址

- 每个主机都设有一个ARP高速缓存(ARP cache),里面有局域网各主机和路由器 IP 地址到硬件地址的映射表

ARP的步骤
1. 本局域网上广播发送一个 ARP 请求分组,分组内容:我的 IP 地址是xxxx,硬件地址 xxxxxxxx。我想知道 IP地址 xxxxx 的主机的硬件地址。

ARP请求->ARP响应

### 4.2.5 IP 数据报的格式
![](http://ww1.sinaimg.cn/large/006rAlqhly1fxa96x6nw8j30dw09e750.jpg)

- 版本 占4位,目前版本号为 4 IPv4。
- 首部长度 占4位,1111 可表示最大十进制数 15.首部长度字段所表示数的单位是 32 位字(1个32位字长是4字节)。因此,首部长度字段最小值是 5(0101)  最大值是 15(1111),15x4=60字节
- 区分服务 占8位。只用在使用区分服务时,这个字段才起作用
- 总长度 总长度指首部和数据之和的长度，单位为字节。总长度占16位,因此数据报的最大长度为 2^16-1=65535字节

> 在 IP 层下面的每一种数据链路层协议都规定了一个数据帧中的数据字段的最大长度,这称为最大传送单元 MTU。当一个 IP 数据报分装成链路层的帧时，此数据报的总长度(首部加数据部分)一定不能超过下面的数据链路。超过就必须把过长的数据报进行分片处理。虽然数据报长了能提高传输效率，但是数据报短些能使路由器转发速度提升。为此 IP 协议规定,因特网中所以的主机和路由器,必须能够接受长度不超过576字节的数据报。


- 标识 占 16 位。 在存储器维持一个计数器,每产生一个数据报,计数器就加 1,将此值赋给标识字段.标识不是序号,因为IP是无连接服务,数据报不存在按序接收问题。当数据报由于长度超过网络的 MTU 而必须分片时,这个标识字段的值就被复制到所有的数据报片的标识字段中。相同的标识字段的值使分片后的各数据报片最后能正确地重装成为原来的数据报。
- 标志 3位,但目前只有两位有意义
    1. MF MF=1 表示后面还有分片的数据报
    2. DF DF=1 不能分片
- 片偏移 占 13 位。 较长的分组在分片后,某片在原分组中的相对位置。也就是说,相对于用户数据字段的起点,改片从何处开始。片偏移以8个字节为偏移单位,也就是说每个分片的长度一定是 8 字节(64位)的整数倍。片偏移计算=开始字节/8;

- 生存时间 占8位,TTL,表明数据报在网络中的寿命。由发出的数据报的源点设置这个字段。目的防止无法交付的数据报无限制地在因特网兜圈子,消耗网络资源。每经过一个路由器时,就把TTL减去数据报在路由器所消耗的一段时间,若数据报在路由器消耗的时间小于小1秒就把 TTL -1.当TTL为0时,就丢弃这个数据报
现在 TTL 功能改为"跳数限制".路由器在转发数据报之前就把 TTL -1 .TTL 的意义是指明数据报在因特网中至多可经过多少个路由器。最大数值255

- 协议占 8 位,协议字段指出此数据报携带的数据时使用何种协议的,以便使目的主机的 IP 层知道应将数据部分上交给那些处理过程。

- 首部检验和 占16位.这个字段只检验数据报的首部,但不包括数据部分。数据报每经过一个路由器,路由器都要重新计算一下(TTL、标志、片偏移等)减少计算量,不使用 CRC校验码

- 源地址 占 32位
- 目的地址 占 32位

### 4.2.6 IP 层转发分组的流程
从一个路由器转发到下一个路由器
路由表
1. 目的网络地址
2. 下一跳地址

路由器还采用**默认路由**以减少路由表所占用的空间和搜索路由表所用的时间.

> 当路由器收到一个待转发的数据报,在从路由表得出下一个路由器 IP 地址后,不是把地址填入 IP 数据报,而是送交数据链路层的网络接口软件。网络接口软件负责把下一跳路由器的地址转换成硬件地址(ARP),将硬件地址放到链路层的 MAC 帧

**分组转发算法**
1. 从数据报的首部提取出目的主机IP地址D,得出目的网络地址 N
2. 若 N 就是与此路由器直接相连的某个网络地址,则进行直接交付,否则就间接交付，执行3
3. 若路由表中有目的地址为D的特定主机路由,则把数据报传送给路由表中所指明的下一跳路由器,否则执行4.
4. 若路由表中有到达网络N的路由,则把数据报传送个路由表指定的下一跳路由器,否则,执行(5)
5. 若路由表中有一个默认路由,则把数据报传送给路由表中所指定的默认路由器,否则6
6. 报告转发分组出错




## 4.3 划分子网和构造超网

### 4.3.1 划分子网
1.从两级地址变为三级IP地址-划分子网

IP 地址::={<网络号>,<子网号>,<主机号>}

2.子网掩码

从IP数据报中无法通过首部查看源主机或目的主机所连接的网络是否进行子网的划分。于是加入了子网掩码与目的IP地址进行与运算,规定所有网络都必须有子网掩码,同时在路由表中也必须要有子网掩码,如果一个网络不划分子网,就是用默认子网掩码。

> 路由器在和相邻路由器交换路由器信息时,必须把自己所在网络的子网掩码告诉相邻路由器。划分子网增加了灵活性,但却减少了能够连接在网络上的主机总数

### 4.3.2 使用子网时分组转发

路由器转发分组算法:
1. 从收到的数据报的首部提取目的主机IP地址D；
2. 先判断是否直接交付,对路由器直接相连的网络逐个进行检查:用各网络的子网掩码和D逐位相“与”,查看结果是否和相应的网络地址匹配。若匹配,则分组进行直接交付,转发分组结束.否则间接交付3
3. 若路由表中的目的地址为 D 的特定主机路由,则把数据报传送给路由表中所指明的下一跳路由器;否则,执行4
4. 对路由表中每一行(目的网络地址,子网掩码,下一跳地址),用其中的子网掩码和D进行与操作，其结果为N.若N与该行的目的地址相匹配,则把数据报发送到下一跳路由器,否则5
5. 默认路由
6. 报告转发分组出错

### 4.3.3 无分类编址 CIDR(构成超网)
CIDR 解决地址不足,以及路由表数目庞大

CIDR 特点:
1. 
