# Kafka 生产者-向 Kafka 写入数据

不管是把 Kafka 作为**消息队列**、**消息总线**还是**数据存储平台**来使用，总是需要有一个：

- 往 Kafka 写入数据的生产者和一个可以从 Kafka 读取数据的消费者
- 或者一个兼具两种角色的应用程序

> 开发者可以使用 Kafka 内置的客户端 API 开发 Kafka 应用程序

本章内容：

- 演示创建 KafkaProducer 和 ProducerRecords 对象
- 如何将记录发送给 Kafka ，以及如何处理从 Kafka 返回的错误，然后介绍用于控制生产者行为的重要配置选项
- 使用不同的**分区方法和序列化器**，如何自定义序列化器和分区器

> **第三方客户端：**除了内置的客户端外，Kafka 还提供了二进制连接协议，也就是说，我们直接向 Kafka 网络端口发送适当的字节序列，就可以实现从 Kafka 读取消息或往 Kafka 写入消息。还有很多用其他语言实现的 Kafka 客户端，比如 C++、Python、Go 语言等

# 生产者概述

一个应用程序在很多情况下需要往 Kafka 写入消息：

- 记录用户的活动(用于审计和分析)
- 记录度量指标
- 保存日志消息
- 记录智能家电的信息
- 与其他应用程序进行异步通信
- 缓冲将写入到数据库的数据

这些信息会有许多的使用场景：

- 是否允许丢失消息

- 偶尔出现重复消息是否可以接受

- 是否可以接受延迟

	![image.png](http://ww1.sinaimg.cn/large/006rAlqhly1gadz5ward3j30sy0lstb2.jpg)

ProducerRecord 对象需要包含目标主题和要发送的内容。在发送 ProducerRecord 对象时，生产者要先把键和值对象序列化成字节数组，这样它们才能够在网络上传输。接下来，数据被传给分区器。如果没有指定分区，那么分区器会根据 ProducerRecord 对象的**键来选择一个分区**。选好分区以后，生产者就知道该往**哪个主题和分区发送到相同的主题**和分区上。有一个独立的线程负责把这些记录批次发送到相应的 broker 上

服务器在收到这些消息时会**返回一个响应**。如果消息成功写入 Kafka，就返回一个 RecordMetaData 对象，它包含了主题和分区信息，以及记录在分区里的偏移量。如果写入失败，则会返回一个错误。生产者在收到错误之后会尝试重新发送消息，几次之后如果还是失败，就返回错误消息

# 创建 Kafka 生产者

要往 Kafka 写入信息，首先要创建一个**生产者对象**，并设置一些属性。Kafka 生产者有 3 个必选的属性

**bootstrap.servers**

该属性指定 broker 的地址清单，地址的格式为 host:port。清单里不需要包含所有的 borker 地址，生产者会从给定的 broker 里查找到其他 broker 的信息。不过创建**至少要提供两个 broker 的信息**，一旦其中一个宕机，生产者任然能够连接到集群上

**key.serializer**

broker 希望接收到的消息的键和值都是**字节数组**。生产者接口允许使用参数化类型,因此可以把 Java 对象作为键和值发送给 broker。这样的代码具有良好的可读性，不过生产者需要知道如何把这些 Java 对象转换成字节数组。